{% extends 'base.html' %}
{% block content %}
<div class="cards">
  <section class="card">
    <h2>Health</h2>
    <div class="meta">Service: <span class="pill {{ 'success' if health.status == 'ok' else 'warn' }}">{{ health.status }}</span></div>
    <div class="meta">DB: <span class="pill {{ 'success' if health.db == 'ok' else 'warn' }}">{{ health.db }}</span></div>
  </section>

  <section class="card">
    <h2>Upcoming Games</h2>
    <div class="meta">Source: <span class="pill muted">{{ upcoming_source or 'unknown' }}</span> • <a href="/upcoming">View JSON</a></div>
    {% if upcoming and upcoming|length > 0 %}
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Time</th><th>Matchup</th>
        </tr>
      </thead>
      <tbody>
        {% for g in upcoming %}
        <tr>
          <td>{{ g.date or 'TBD' }}</td>
          <td>{{ g.time or 'TBD' }}</td>
          <td class="matchup">{{ g.away or g.name.split(' @ ')[0] }} <span style="color: var(--muted);">@</span> {{ g.home or g.name.split(' @ ')[1] if ' @ ' in g.name else g.name }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p>No upcoming games found in the next 7 days.</p>
    {% endif %}
  </section>

  <section class="card" style="grid-column: 1 / -1;">
    <h2>Predictions (Cached)</h2>
    <div class="meta">Status: <span class="pill {{ 'success' if pred_status == 'ok' else 'warn' if pred_status != 'no-cache' else 'muted' }}">{{ pred_status }}</span> • Count: {{ pred_count }}</div>
    {% if pred_status == 'no-cache' %}
      <p><strong>No predictions cached yet.</strong> Run predictions to populate the board.</p>
    {% elif predictions and predictions|length > 0 %}
    <table>
      <thead>
        <tr>
          <th>Matchup</th><th>Favorite</th><th>Total (pts)</th><th>Win Prob (fav)</th><th>Timestamp</th>
        </tr>
      </thead>
      <tbody>
        {% for p in predictions %}
        {% set margin = (p.pred_margin_home or 0) %}
        {% set total = (p.pred_total or 0) %}
        {% set fav = p.home_team if margin >= 0 else p.away_team %}
        {% set spread = margin if margin >= 0 else -margin %}
        {% set winprob_fav = (p.pred_winprob_home or 0) if margin >= 0 else (1 - (p.pred_winprob_home or 0)) %}
        <tr>
          <td class="matchup"><span class="tag away">Away</span>{{ p.away_team }} <span style="color: var(--muted);">@</span> <span class="tag home">Home</span>{{ p.home_team }}</td>
          <td><span class="favorite">{{ fav }} <span class="spread">-{{ '%.1f'|format(spread) }}</span></span></td>
          <td class="totals"><strong>{{ '%.1f'|format(total) }}</strong><small>Projected total</small></td>
          <td><span class="winprob">{{ '%.1f'|format(winprob_fav * 100) }}%</span></td>
          <td>{{ p.timestamp[:19] if p.timestamp else '-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p>No predictions available yet.</p>
    {% endif %}
    <form method="post" action="/ui/refresh-upcoming" class="actions">
      <button type="submit" class="primary">Run Predictions for Upcoming Games</button>
      <small>May take 1-2 minutes.</small>
    </form>
  </section>
</div>
{% endblock %}
